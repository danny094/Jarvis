#!/usr/bin/env python3
"""
Integration Test for Persona REST API
Tests all endpoints from Phase 2

Tests:
- GET /api/personas/           (list all)
- GET /api/personas/{name}     (get specific)
- POST /api/personas/          (upload)
- PUT /api/personas/switch     (activate)
- DELETE /api/personas/{name}  (delete)
"""

import requests
import pytest
import time
from pathlib import Path

# ============================================================
# CONFIGURATION
# ============================================================

API_BASE = "http://localhost:8100"
API_URL = f"{API_BASE}/api/personas"

# ============================================================
# TEST DATA
# ============================================================

TEST_PERSONA = """# Persona: Test Bot
[IDENTITY]
name: TestBot
role: Test Assistant
language: english

[PERSONALITY]
- helpful
- friendly

[STYLE]
tone: casual
verbosity: concise

[RULES]
1. Be helpful
2. Be honest
"""

INVALID_PERSONA = """# Missing [IDENTITY] section
name: Invalid
"""

# ============================================================
# HELPER FUNCTIONS
# ============================================================

def check_api_available():
    """Check if API is running"""
    try:
        response = requests.get(f"{API_BASE}/health", timeout=5)
        return response.status_code == 200
    except:
        return False

# ============================================================
# FIXTURES
# ============================================================

@pytest.fixture(scope="session", autouse=True)
def check_prerequisites():
    """Check API is running before tests"""
    if not check_api_available():
        pytest.skip(f"API not available at {API_BASE}")

@pytest.fixture
def test_persona_file(tmp_path):
    """Create temporary persona file"""
    file_path = tmp_path / "test_bot.txt"
    file_path.write_text(TEST_PERSONA, encoding="utf-8")
    return file_path

@pytest.fixture
def cleanup_test_personas():
    """Cleanup test personas after each test"""
    yield
    # Delete test_bot if exists
    try:
        requests.delete(f"{API_URL}/test_bot", timeout=5)
    except:
        pass

# ============================================================
# TESTS
# ============================================================

class TestPersonaListEndpoint:
    """Test GET /api/personas/"""
    
    def test_list_personas_success(self):
        """Should list all personas"""
        response = requests.get(API_URL)
        
        assert response.status_code == 200
        data = response.json()
        
        assert "personas" in data
        assert "active" in data
        assert "count" in data
        assert isinstance(data["personas"], list)
        assert isinstance(data["count"], int)
        
        # Default should exist
        assert "default" in data["personas"]
        
        print(f"‚úÖ List: {data['count']} personas found")
        print(f"   Personas: {data['personas']}")
        print(f"   Active: {data['active']}")


class TestPersonaGetEndpoint:
    """Test GET /api/personas/{name}"""
    
    def test_get_default_persona(self):
        """Should get default persona"""
        response = requests.get(f"{API_URL}/default")
        
        assert response.status_code == 200
        data = response.json()
        
        assert "name" in data
        assert "content" in data
        assert "size" in data
        assert "created" in data
        
        assert data["name"] == "default"
        assert len(data["content"]) > 0
        assert "[IDENTITY]" in data["content"]
        
        print(f"‚úÖ Get default: {data['size']} bytes")
    
    def test_get_nonexistent_persona(self):
        """Should return 404 for non-existent persona"""
        response = requests.get(f"{API_URL}/nonexistent")
        
        assert response.status_code == 404
        data = response.json()
        assert "detail" in data
        
        print(f"‚úÖ Get nonexistent: 404 as expected")


class TestPersonaUploadEndpoint:
    """Test POST /api/personas/"""
    
    def test_upload_new_persona(self, test_persona_file, cleanup_test_personas):
        """Should upload new persona"""
        with open(test_persona_file, 'rb') as f:
            files = {'file': ('test_bot.txt', f, 'text/plain')}
            response = requests.post(API_URL, files=files)
        
        assert response.status_code == 200
        data = response.json()
        
        assert data["success"] is True
        assert data["name"] == "test_bot"
        assert data["size"] > 0
        assert "uploaded successfully" in data["message"]
        
        print(f"‚úÖ Upload: test_bot ({data['size']} bytes)")
    
    def test_upload_overwrites_existing(self, test_persona_file, cleanup_test_personas):
        """Should overwrite existing persona"""
        # Upload twice
        with open(test_persona_file, 'rb') as f:
            files = {'file': ('test_bot.txt', f, 'text/plain')}
            requests.post(API_URL, files=files)
        
        with open(test_persona_file, 'rb') as f:
            files = {'file': ('test_bot.txt', f, 'text/plain')}
            response = requests.post(API_URL, files=files)
        
        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        
        print(f"‚úÖ Overwrite: test_bot updated")
    
    def test_upload_invalid_extension(self, tmp_path):
        """Should reject non-.txt files"""
        file_path = tmp_path / "test.pdf"
        file_path.write_text("test", encoding="utf-8")
        
        with open(file_path, 'rb') as f:
            files = {'file': ('test.pdf', f, 'application/pdf')}
            response = requests.post(API_URL, files=files)
        
        assert response.status_code == 400
        data = response.json()
        assert "must be .txt" in data["detail"]
        
        print(f"‚úÖ Invalid extension: rejected")
    
    def test_upload_too_large_file(self, tmp_path):
        """Should reject files > 10KB"""
        file_path = tmp_path / "large.txt"
        file_path.write_text("x" * 11000, encoding="utf-8")  # 11KB
        
        with open(file_path, 'rb') as f:
            files = {'file': ('large.txt', f, 'text/plain')}
            response = requests.post(API_URL, files=files)
        
        assert response.status_code == 400
        data = response.json()
        assert "too large" in data["detail"]
        
        print(f"‚úÖ Too large: rejected")
    
    def test_upload_invalid_utf8(self, tmp_path):
        """Should reject non-UTF-8 files"""
        file_path = tmp_path / "invalid.txt"
        file_path.write_bytes(b'\x80\x81\x82')  # Invalid UTF-8
        
        with open(file_path, 'rb') as f:
            files = {'file': ('invalid.txt', f, 'text/plain')}
            response = requests.post(API_URL, files=files)
        
        assert response.status_code == 400
        data = response.json()
        assert "UTF-8" in data["detail"]
        
        print(f"‚úÖ Invalid UTF-8: rejected")


class TestPersonaSwitchEndpoint:
    """Test PUT /api/personas/switch"""
    
    def test_switch_to_existing_persona(self, test_persona_file, cleanup_test_personas):
        """Should switch to existing persona"""
        # Upload test persona first
        with open(test_persona_file, 'rb') as f:
            files = {'file': ('test_bot.txt', f, 'text/plain')}
            requests.post(API_URL, files=files)
        
        # Switch to it
        response = requests.put(f"{API_URL}/switch", params={"name": "test_bot"})
        
        assert response.status_code == 200
        data = response.json()
        
        assert data["success"] is True
        assert data["current"] == "test_bot"
        assert data["persona_name"] == "TestBot"
        
        print(f"‚úÖ Switch: default ‚Üí test_bot")
        
        # Verify active changed
        list_response = requests.get(API_URL)
        list_data = list_response.json()
        assert list_data["active"] == "test_bot"
        
        # Switch back to default
        requests.put(f"{API_URL}/switch", params={"name": "default"})
    
    def test_switch_to_nonexistent(self):
        """Should return 404 for non-existent persona"""
        response = requests.put(f"{API_URL}/switch", params={"name": "nonexistent"})
        
        assert response.status_code == 404
        data = response.json()
        assert "not found" in data["detail"]
        
        print(f"‚úÖ Switch nonexistent: 404 as expected")


class TestPersonaDeleteEndpoint:
    """Test DELETE /api/personas/{name}"""
    
    def test_delete_existing_persona(self, test_persona_file, cleanup_test_personas):
        """Should delete existing persona"""
        # Upload test persona first
        with open(test_persona_file, 'rb') as f:
            files = {'file': ('test_bot.txt', f, 'text/plain')}
            requests.post(API_URL, files=files)
        
        # Delete it
        response = requests.delete(f"{API_URL}/test_bot")
        
        assert response.status_code == 200
        data = response.json()
        
        assert data["success"] is True
        assert data["deleted"] == "test_bot"
        
        print(f"‚úÖ Delete: test_bot removed")
        
        # Verify it's gone
        list_response = requests.get(API_URL)
        list_data = list_response.json()
        assert "test_bot" not in list_data["personas"]
    
    def test_delete_default_protected(self):
        """Should not delete default persona"""
        response = requests.delete(f"{API_URL}/default")
        
        assert response.status_code == 400
        data = response.json()
        assert "protected" in data["detail"].lower()
        
        print(f"‚úÖ Delete default: protected")
    
    def test_delete_active_persona(self, test_persona_file, cleanup_test_personas):
        """Should not delete active persona"""
        # Upload and switch to test persona
        with open(test_persona_file, 'rb') as f:
            files = {'file': ('test_bot.txt', f, 'text/plain')}
            requests.post(API_URL, files=files)
        
        requests.put(f"{API_URL}/switch", params={"name": "test_bot"})
        
        # Try to delete
        response = requests.delete(f"{API_URL}/test_bot")
        
        assert response.status_code == 400
        data = response.json()
        assert "active" in data["detail"].lower()
        
        print(f"‚úÖ Delete active: rejected")
        
        # Switch back and delete
        requests.put(f"{API_URL}/switch", params={"name": "default"})
        requests.delete(f"{API_URL}/test_bot")
    
    def test_delete_nonexistent(self):
        """Should return 404 for non-existent persona"""
        response = requests.delete(f"{API_URL}/nonexistent")
        
        assert response.status_code == 404
        data = response.json()
        assert "not found" in data["detail"]
        
        print(f"‚úÖ Delete nonexistent: 404 as expected")


class TestPersonaIntegration:
    """End-to-end integration tests"""
    
    def test_full_workflow(self, test_persona_file, cleanup_test_personas):
        """Test complete persona lifecycle"""
        print("\nüîÑ Testing full workflow...")
        
        # 1. List initial
        response = requests.get(API_URL)
        initial_count = response.json()["count"]
        print(f"   Initial count: {initial_count}")
        
        # 2. Upload
        with open(test_persona_file, 'rb') as f:
            files = {'file': ('test_bot.txt', f, 'text/plain')}
            response = requests.post(API_URL, files=files)
        assert response.status_code == 200
        print(f"   ‚úÖ Uploaded test_bot")
        
        # 3. Verify in list
        response = requests.get(API_URL)
        data = response.json()
        assert "test_bot" in data["personas"]
        assert data["count"] == initial_count + 1
        print(f"   ‚úÖ Found in list ({data['count']} total)")
        
        # 4. Get content
        response = requests.get(f"{API_URL}/test_bot")
        assert response.status_code == 200
        content = response.json()["content"]
        assert "[IDENTITY]" in content
        print(f"   ‚úÖ Retrieved content")
        
        # 5. Switch to it
        response = requests.put(f"{API_URL}/switch", params={"name": "test_bot"})
        assert response.status_code == 200
        assert response.json()["current"] == "test_bot"
        print(f"   ‚úÖ Switched to test_bot")
        
        # 6. Verify active
        response = requests.get(API_URL)
        assert response.json()["active"] == "test_bot"
        print(f"   ‚úÖ Active persona changed")
        
        # 7. Switch back
        response = requests.put(f"{API_URL}/switch", params={"name": "default"})
        assert response.status_code == 200
        print(f"   ‚úÖ Switched back to default")
        
        # 8. Delete
        response = requests.delete(f"{API_URL}/test_bot")
        assert response.status_code == 200
        print(f"   ‚úÖ Deleted test_bot")
        
        # 9. Verify gone
        response = requests.get(API_URL)
        data = response.json()
        assert "test_bot" not in data["personas"]
        assert data["count"] == initial_count
        print(f"   ‚úÖ Removed from list ({data['count']} total)")
        
        print(f"‚úÖ Full workflow complete!")


# ============================================================
# RUN TESTS
# ============================================================

if __name__ == "__main__":
    import sys
    
    print("=" * 60)
    print("PERSONA REST API INTEGRATION TEST")
    print("=" * 60)
    print(f"API: {API_BASE}")
    print(f"Endpoint: {API_URL}")
    print()
    
    if not check_api_available():
        print("‚ùå API not available!")
        print(f"   Make sure lobechat-adapter is running on {API_BASE}")
        sys.exit(1)
    
    print("‚úÖ API is available")
    print()
    
    # Run pytest
    pytest.main([__file__, "-v", "--tb=short", "-s"])
