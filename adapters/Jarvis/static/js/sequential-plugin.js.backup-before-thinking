/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * SEQUENTIAL THINKING PLUGIN
 * Event-based Observability for Sequential Thinking
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * Architecture:
 * - Listens to sequential_* events from backend
 * - Uses TRIONPanel API to visualize (NO business logic!)
 * - Pure Observability Surface
 */

class SequentialThinkingPlugin {
    constructor(panel) {
        this.panel = panel;
        this.activeTasks = new Map(); // task_id -> {tabId, steps, startTime}
        
        console.log('[SequentialPlugin] Initialized');
    }
    
    /**
     * Initialize event listeners
     */
    init() {
        // Listen to SSE events
        window.addEventListener('sse-event', (e) => {
            const event = e.detail;
            
            switch(event.type) {
                case 'sequential_start':
                    this.handleStart(event);
                    break;
                case 'sequential_step':
                    this.handleStep(event);
                    break;
                case 'sequential_done':
                    this.handleDone(event);
                    break;
                case 'sequential_error':
                    this.handleError(event);
                    break;
            }
        });
        
        console.log('[SequentialPlugin] Event listeners registered');
    }
    
    /**
     * Handle sequential_start event
     */
    handleStart(event) {
        console.log('[SequentialPlugin] Starting task:', event.task_id);
        
        const { task_id, complexity, cim_modes, reasoning_type } = event;
        
        // Build initial content
        let content = '# Sequential Thinking\n\n';
        content += `**Task ID:** \`${task_id}\`\n`;
        content += `**Complexity:** ${complexity} steps\n`;
        if (cim_modes && cim_modes.length > 0) {
            content += `**CIM Modes:** ${cim_modes.join(', ')}\n`;
        }
        if (reasoning_type) {
            content += `**Reasoning:** ${reasoning_type}\n`;
        }
        content += `**Status:** ðŸ”„ Running...\n\n`;
        content += `---\n\n`;
        
        // Create tab in panel (PURE VISUALIZATION)
        const tabId = this.panel.createTab(
            task_id,
            `Sequential (${complexity} steps)`,
            'markdown',
            {
                autoOpen: true,
                content: content
            }
        );
        
        // Track task
        this.activeTasks.set(task_id, {
            tabId: task_id,
            steps: [],
            startTime: Date.now(),
            complexity: complexity
        });
    }
    
    /**
     * Handle sequential_step event
     */
    handleStep(event) {
        const { task_id, step_number, title, thought, status } = event;
        const task = this.activeTasks.get(task_id);
        
        if (!task) {
            console.warn('[SequentialPlugin] Received step for unknown task:', task_id);
            return;
        }
        
        console.log(`[SequentialPlugin] Step ${step_number}/${task.complexity} for ${task_id}`);
        
        // Build step content
        let stepContent = `## Step ${step_number}: ${title}\n\n`;
        stepContent += `${thought}\n\n`;
        
        // Status indicator
        if (status === 'complete') {
            stepContent += `âœ… Complete\n\n`;
        } else if (status === 'running') {
            stepContent += `ðŸ”„ Running...\n\n`;
        }
        
        stepContent += `---\n\n`;
        
        // Update panel (PURE VISUALIZATION)
        this.panel.updateContent(task_id, stepContent, true);
        
        // Track step
        task.steps.push(event);
    }
    
    /**
     * Handle sequential_done event
     */
    handleDone(event) {
        const { task_id, steps, summary } = event;
        const task = this.activeTasks.get(task_id);
        
        if (!task) {
            console.warn('[SequentialPlugin] Received done for unknown task:', task_id);
            return;
        }
        
        const duration = ((Date.now() - task.startTime) / 1000).toFixed(1);
        
        console.log(`[SequentialPlugin] Task ${task_id} completed in ${duration}s`);
        
        // Build summary content
        let summaryContent = `---\n\n`;
        summaryContent += `## Summary\n\n`;
        summaryContent += `${summary}\n\n`;
        summaryContent += `**Total Steps:** ${steps.length}\n`;
        summaryContent += `**Duration:** ${duration}s\n\n`;
        summaryContent += `**Status:** âœ… Complete\n`;
        
        // Update panel (PURE VISUALIZATION)
        this.panel.updateContent(task_id, summaryContent, true);
        
        // Cleanup
        this.activeTasks.delete(task_id);
    }
    
    /**
     * Handle sequential_error event
     */
    handleError(event) {
        const { task_id, error } = event;
        const task = this.activeTasks.get(task_id);
        
        console.error('[SequentialPlugin] Error for task:', task_id, error);
        
        if (!task) {
            // Create error tab if task wasn't started
            this.panel.createTab(
                task_id,
                'Sequential Error',
                'markdown',
                {
                    autoOpen: true,
                    content: `# Sequential Thinking Error\n\nâŒ ${error}\n`
                }
            );
            return;
        }
        
        // Update existing tab
        const errorContent = `\n\n---\n\nâŒ **Error:** ${error}\n`;
        this.panel.updateContent(task_id, errorContent, true);
        
        // Cleanup
        this.activeTasks.delete(task_id);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTO-INITIALIZE (when TRIONPanel is ready)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        if (window.TRIONPanel) {
            window.sequentialPlugin = new SequentialThinkingPlugin(window.TRIONPanel);
            window.sequentialPlugin.init();
        } else {
            console.error('[SequentialPlugin] TRIONPanel not found!');
        }
    });
} else {
    if (window.TRIONPanel) {
        window.sequentialPlugin = new SequentialThinkingPlugin(window.TRIONPanel);
        window.sequentialPlugin.init();
    } else {
        // Retry after a short delay
        setTimeout(() => {
            if (window.TRIONPanel) {
                window.sequentialPlugin = new SequentialThinkingPlugin(window.TRIONPanel);
                window.sequentialPlugin.init();
            }
        }, 100);
    }
}
