/**
 * Sequential Thinking Mode - Frontend Controller
 * Manages Sequential Mode UI and MCP Server integration
 * 
 * @version 1.0.0
 * @date 2026-01-17
 */

class SequentialThinking {
    constructor() {
        this.enabled = false;
        this.currentTask = null;
        this.pollInterval = null;
        this.mcpServerUrl = 'http://localhost:8001';
    }

    /**
     * Initialize UI elements
     * Creates toggle in settings and progress tracking section
     */
    initUI() {
        console.log('[SequentialThinking] Initializing UI...');
        
        // 1. Settings Toggle Section
        const toggleHTML = `
            <div id="sequential-mode-container" class="space-y-4 p-4 bg-dark-card rounded-lg border border-dark-border">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-sm font-medium text-white flex items-center gap-2">
                            <i data-lucide="brain" class="w-4 h-4"></i>
                            Sequential Thinking Mode
                        </h3>
                        <p class="text-xs text-gray-400 mt-1">
                            Enable step-by-step reasoning with Frank's CIM validation
                        </p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="sequential-mode-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-dark-border rounded-full peer 
                                    peer-checked:bg-primary-500 peer-focus:ring-2 
                                    peer-focus:ring-primary-500/50 transition-colors">
                            <div class="absolute top-0.5 left-0.5 bg-white rounded-full h-5 w-5 
                                        transition-transform peer-checked:translate-x-5"></div>
                        </div>
                    </label>
                </div>
            </div>
        `;
        
        // Insert into settings panel (find appropriate location)
        const settingsContent = document.querySelector('#settings-modal .space-y-6');
        if (settingsContent) {
            settingsContent.insertAdjacentHTML('beforeend', toggleHTML);
            lucide.createIcons(); // Re-initialize icons
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ¨ DESIGN DECISION POINT - LIVE PROGRESS UI
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // 
        // TODO: STRUKTURIERTE PLANUNG ERFORDERLICH MIT DANNY!
        // 
        // Fragen fÃ¼r Design-Session:
        // 1. WO soll das Progress UI erscheinen?
        //    - Sidebar rechts/links?
        //    - Overlay Ã¼ber Chat?
        //    - Eingebettet im Chat-Flow?
        //    - Eigener Tab/Modal?
        // 
        // 2. WIE sollen die Steps visualisiert werden?
        //    - Timeline vertical/horizontal?
        //    - Karten/Cards?
        //    - Liste mit Status-Icons?
        //    - Graph/Flowchart?
        // 
        // 3. WELCHE Informationen pro Step?
        //    - Status (pending/executing/verified/failed)
        //    - Progress Bar
        //    - CIM Validation Details
        //    - Dependencies/Connections
        //    - Execution Time
        // 
        // 4. INTERAKTIVITÃ„T?
        //    - Stop Button
        //    - Pause/Resume?
        //    - Step Details expandieren?
        //    - Download State?
        // 
        // Aktuell: Placeholder fÃ¼r strukturierte Design-Session
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        const progressHTML = `
            <div id="sequential-progress" class="hidden">
                <!-- PLACEHOLDER: Design wird in strukturierter Session festgelegt -->
                <div class="p-4 bg-dark-card rounded-lg border border-primary-500">
                    <h4 class="text-sm font-medium text-white mb-2">Sequential Thinking Active</h4>
                    <div class="space-y-2">
                        <div id="progress-bar-container" class="w-full bg-dark-bg rounded-full h-2">
                            <div id="progress-fill" class="bg-primary-500 h-2 rounded-full transition-all" 
                                 style="width: 0%"></div>
                        </div>
                        <div id="progress-text" class="text-xs text-gray-400">0%</div>
                        
                        <div id="sequential-steps" class="space-y-1 mt-4">
                            <!-- Steps werden hier eingefÃ¼gt - Design TBD -->
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            <button id="stop-sequential" 
                                    class="px-3 py-1.5 bg-red-500 hover:bg-red-600 
                                           text-white text-xs rounded transition-colors">
                                Stop Task
                            </button>
                            <button id="download-state" 
                                    class="px-3 py-1.5 bg-dark-border hover:bg-dark-hover 
                                           text-white text-xs rounded transition-colors">
                                Download State
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Insert into chat container (temporary placement)
        const chatContainer = document.querySelector('#chat-container');
        if (chatContainer) {
            chatContainer.insertAdjacentHTML('afterbegin', progressHTML);
        }
        
        this.attachEventListeners();
    }

    /**
     * Attach event handlers to UI elements
     */
    attachEventListeners() {
        const toggleEl = document.getElementById('sequential-mode-toggle');
        if (toggleEl) {
            toggleEl.addEventListener('change', (e) => {
                this.toggle(e.target.checked);
            });
        }
        
        const stopBtn = document.getElementById('stop-sequential');
        if (stopBtn) {
            stopBtn.addEventListener('click', () => {
                this.stopTask();
            });
        }
        
        const downloadBtn = document.getElementById('download-state');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => {
                this.downloadState();
            });
        }
    }

    /**
     * Toggle sequential mode on/off
     * @param {boolean} enabled - Enable or disable sequential mode
     */
    toggle(enabled) {
        this.enabled = enabled;
        console.log(`[SequentialThinking] Mode: ${enabled ? 'ENABLED' : 'DISABLED'}`);
        
        // Show/hide progress UI
        const progressEl = document.getElementById('sequential-progress');
        if (progressEl) {
            progressEl.classList.toggle('hidden', !enabled);
        }
        
        // Update chat input placeholder
        if (enabled) {
            const inputEl = document.querySelector('#message-input');
            if (inputEl) {
                inputEl.dataset.originalPlaceholder = inputEl.placeholder;
                inputEl.placeholder = "ğŸ§  Ask a complex question for step-by-step analysis...";
            }
        } else {
            const inputEl = document.querySelector('#message-input');
            if (inputEl && inputEl.dataset.originalPlaceholder) {
                inputEl.placeholder = inputEl.dataset.originalPlaceholder;
            }
        }
    }

    /**
     * Execute task in sequential mode
     * @param {string} message - User message/query
     * @returns {Promise<Object|null>} - Task response or null
     */
    async executeTask(message) {
        if (!this.enabled) {
            return null; // Not in sequential mode
        }
        
        console.log('[SequentialThinking] Executing task:', message);
        
        try {
            const response = await fetch('/chat/sequential', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: message,
                    sequential_mode: true
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.task_id) {
                this.currentTask = data.task_id;
                this.startPolling();
            }
            
            return data;
            
        } catch (error) {
            console.error('[SequentialThinking] Execution failed:', error);
            this.showError('Failed to start sequential task. Falling back to regular mode.');
            return null;
        }
    }

    /**
     * Start polling for task progress
     */
    startPolling() {
        if (this.pollInterval) {
            clearInterval(this.pollInterval);
        }
        
        console.log('[SequentialThinking] Starting progress polling...');
        
        this.pollInterval = setInterval(async () => {
            if (!this.currentTask) return;
            
            try {
                const response = await fetch(`/sequential/status/${this.currentTask}`);
                
                if (!response.ok) {
                    console.warn('[SequentialThinking] Status check failed:', response.status);
                    return;
                }
                
                const data = await response.json();
                this.updateProgress(data);
                
                // Stop polling if task complete
                if (data.progress >= 1.0 || data.status === 'complete') {
                    console.log('[SequentialThinking] Task complete, stopping poll');
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                }
                
            } catch (error) {
                console.error('[SequentialThinking] Polling error:', error);
            }
        }, 500); // Poll every 500ms
    }

    /**
     * Update progress UI with latest data
     * @param {Object} data - Progress data from server
     */
    updateProgress(data) {
        // Update progress bar
        const progress = Math.round((data.progress || 0) * 100);
        const fillEl = document.getElementById('progress-fill');
        const textEl = document.getElementById('progress-text');
        
        if (fillEl) fillEl.style.width = `${progress}%`;
        if (textEl) textEl.textContent = `${progress}%`;
        
        // Update steps
        if (data.steps) {
            this.displaySteps(data.steps);
        }
    }

    /**
     * Display steps with status indicators
     * @param {Array} steps - Array of step objects
     */
    displaySteps(steps) {
        const stepsContainer = document.getElementById('sequential-steps');
        if (!stepsContainer) return;
        
        const icons = {
            'verified': 'âœ…',
            'executing': 'âš™ï¸',
            'failed': 'âŒ',
            'pending': 'â¸ï¸'
        };
        
        const stepsHTML = steps.map(step => {
            const icon = icons[step.status] || 'â¸ï¸';
            const statusColor = {
                'verified': 'text-green-400',
                'executing': 'text-blue-400',
                'failed': 'text-red-400',
                'pending': 'text-gray-400'
            }[step.status] || 'text-gray-400';
            
            return `
                <div class="flex items-start gap-2 text-xs ${statusColor}">
                    <span class="text-base">${icon}</span>
                    <div class="flex-1">
                        <div>${step.description || 'Unknown step'}</div>
                        ${step.cim_validation ? `
                            <div class="text-xs text-gray-500 mt-0.5">
                                CIM: ${step.cim_validation.priors_checked || 0} priors checked
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        stepsContainer.innerHTML = stepsHTML;
    }

    /**
     * Stop current sequential task
     */
    async stopTask() {
        if (!this.currentTask) {
            console.warn('[SequentialThinking] No active task to stop');
            return;
        }
        
        console.log('[SequentialThinking] Stopping task:', this.currentTask);
        
        try {
            await fetch(`/sequential/stop/${this.currentTask}`, {
                method: 'POST'
            });
            
            clearInterval(this.pollInterval);
            this.pollInterval = null;
            this.currentTask = null;
            
            console.log('[SequentialThinking] Task stopped');
            
        } catch (error) {
            console.error('[SequentialThinking] Stop failed:', error);
        }
    }

    /**
     * Download current task state as JSON
     */
    async downloadState() {
        if (!this.currentTask) {
            console.warn('[SequentialThinking] No active task to download');
            return;
        }
        
        try {
            const response = await fetch(`/sequential/status/${this.currentTask}`);
            const data = await response.json();
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sequential_task_${this.currentTask}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            console.log('[SequentialThinking] State downloaded');
            
        } catch (error) {
            console.error('[SequentialThinking] Download failed:', error);
        }
    }

    /**
     * Show error message to user
     * @param {string} message - Error message
     */
    showError(message) {
        console.error('[SequentialThinking]', message);
        // TODO: Integrate with Jarvis notification system
        alert(message);
    }
}

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
    module.exports = SequentialThinking;
}
