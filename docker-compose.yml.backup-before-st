# docker-compose.yml (Neue modulare Version mit Shared Volumes)
#
# Services:
# - lobechat-adapter:  Port 8100 ‚Üí LobeChat tr√§gt diese URL ein
# - openwebui-adapter: Port 8200 ‚Üí Open WebUI tr√§gt diese URL ein (optional)
# - mcp-sql-memory:    Port 8082 ‚Üí Memory-Server (intern 8081)
# - validator-service: Port 8300 ‚Üí Validator (intern 8000)
#
# Netzwerk: big-bear-lobe-chat_default (extern, muss existieren)
#
# SHARED VOLUMES: Core-Code wird nicht mehr in Container kopiert,
# sondern live gemountet. √Ñnderungen an Core = nur Container restart!

services:
  # ============================================================
  # LOBECHAT ADAPTER
  # ============================================================
  lobechat-adapter:
    build:
      context: .
      dockerfile: adapters/lobechat/Dockerfile
    container_name: lobechat-adapter
    ports:
      - "8100:8100"
    environment:
      # Service URLs
      - OLLAMA_BASE=http://ollama:11434
      - MCP_BASE=http://mcp-sql-memory:8081/mcp
      - VALIDATOR_URL=http://validator-service:8000
      
      # Model Konfiguration (√§nderbar!)
      - THINKING_MODEL=deepseek-r1:8b
      - CONTROL_MODEL=qwen3:4b
      - OUTPUT_MODEL=llama3.1:8b
      - EMBEDDING_MODEL=hellord/mxbai-embed-large-v1:f16
      
      # Layer Toggles (Speed-Optimierung!)
      - ENABLE_CONTROL_LAYER=true
      - SKIP_CONTROL_ON_LOW_RISK=true   # ‚Üê SPEED BOOST!
      
      # Validation
      - ENABLE_VALIDATION=true
      - VALIDATION_HARD_FAIL=true
      - LOG_LEVEL=INFO
    volumes:
      # Config & Personas (wie vorher)
      - ./config:/app/config:ro
      - ./personas:/app/personas
      # üÜï SHARED VOLUMES - Core Code live gemountet!
      - ./core:/app/core:ro
      - ./intelligence_modules:/app/intelligence_modules:ro
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped
    depends_on:
      - mcp-sql-memory

  # ============================================================
  # JARVIS WEB UI (Debug/Chat Interface)
  # ============================================================
  jarvis-webui:
    build:
      context: adapters/Jarvis
      dockerfile: Dockerfile
    container_name: jarvis-webui
    ports:
      - "8400:80"
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped
    depends_on:
      - lobechat-adapter

  # ============================================================
  # JARVIS ADMIN API (Management API for WebUI)
  # ============================================================
  jarvis-admin-api:
    build:
      context: .
      dockerfile: adapters/admin-api/Dockerfile
    container_name: jarvis-admin-api
    ports:
      - "8200:8200"
    environment:
      - MCP_BASE=http://mcp-sql-memory:8081/mcp
      - LOG_LEVEL=INFO
    volumes:
      # Personas (wie vorher)
      - ./personas:/app/personas
      # üÜï SHARED VOLUMES - Core Code live gemountet!
      - ./core:/app/core:ro
      - ./intelligence_modules:/app/intelligence_modules:ro
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped
    depends_on:
      - mcp-sql-memory

  # ============================================================
  # OPEN WEBUI ADAPTER (optional - auskommentieren wenn nicht gebraucht)
  # NOTE: Changed port to 8250 (8200 now used by jarvis-admin-api)
  # ============================================================
  # openwebui-adapter:
  #   build:
  #     context: .
  #     dockerfile: adapters/openwebui/Dockerfile
  #   container_name: openwebui-adapter
  #   ports:
  #     - "8250:8200"
  #   environment:
  #     - OLLAMA_BASE=http://ollama:11434
  #     - MCP_BASE=http://mcp-sql-memory:8081/mcp
  #     - VALIDATOR_URL=http://validator-service:8000
  #     - ENABLE_VALIDATION=true
  #     - LOG_LEVEL=INFO
  #   volumes:
  #     # üÜï SHARED VOLUMES - Core Code live gemountet!
  #     - ./core:/app/core:ro
  #     - ./intelligence_modules:/app/intelligence_modules:ro
  #   networks:
  #     - big-bear-lobe-chat_default
  #   restart: unless-stopped

  # ============================================================
  # MCP SQL MEMORY SERVER
  # ============================================================
  mcp-sql-memory:
    build:
      context: ./sql-memory
    container_name: mcp-sql-memory
    environment:
      - DB_PATH=/app/data/memory.db
      - OLLAMA_URL=http://ollama:11434
      - EMBEDDING_MODEL=hellord/mxbai-embed-large-v1:f16
    volumes:
      - ./sql-memory/data:/app/data
    ports:
      - "8082:8081"
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped

  # ============================================================
  # VALIDATOR SERVICE
  # ============================================================
  validator-service:
    build:
      context: ./validator-service/validator-service
    container_name: validator-service
    environment:
      - OLLAMA_BASE_URL=http://ollama:11434
      - EMBEDDING_MODEL=hellord/mxbai-embed-large-v1:f16
      - VALIDATOR_MODEL=qwen2.5:0.5b-instruct
    ports:
      - "8300:8000"
    networks:
      - big-bear-lobe-chat_default
    restart: unless-stopped

networks:
  big-bear-lobe-chat_default:
    external: true
